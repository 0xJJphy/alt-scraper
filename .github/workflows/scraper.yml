name: Alts Scraper Pipeline

on:
  schedule:
    # Madrid is UTC+1 (Winter) / UTC+2 (Summer)
    # 1. Daily Close: 1 AM Madrid = 00:00 UTC (Winter) / 23:00 UTC (Summer)
    #    Target: ~00:15 UTC to ensure daily candle is closed and available.
    - cron: '15 0 * * *'
    
    # 2. Pre-Opening (US/Session): 3 PM Madrid = 14:00 UTC (Winter) / 13:00 UTC (Summer)
    #    Target: 14:00 UTC (compromise)
    - cron: '0 14 * * *'
    
    # 3. Pre-Close/Evening: 7 PM Madrid = 18:00 UTC (Winter) / 17:00 UTC (Summer)
    #    Target: 18:00 UTC
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      lookback_days:
        description: 'Days to look back (default: 1)'
        required: false
        default: '1'
      top_n:
        description: 'Number of top tokens (default: 50)'
        required: false
        default: '50'
      parallel_execution:
        description: 'Run Spot and Futures in parallel (default: false)'
        type: boolean
        required: false
        default: false
    
    env:
      PYTHONUNBUFFERED: "1"

jobs:
  sync-metadata:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COINALYZE_API_KEY: ${{ secrets.COINALYZE_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Setup VPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn iproute2
          python get_vpn_config.py
          # Start OpenVPN in background
          sudo openvpn --config client.ovpn --log vpn.log --daemon
          
          echo "Waiting for VPN connection to establish..."
          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            sleep 10
            # Check exit IP
            IP_INFO=$(curl -s https://ipinfo.io/json || echo '{"country": "ERROR"}')
            COUNTRY=$(echo $IP_INFO | grep -oP '"country": "\K[^"]+')
            IP=$(echo $IP_INFO | grep -oP '"ip": "\K[^"]+')
            echo "Current IP: $IP ($COUNTRY) [Attempt $((COUNT+1))/$MAX_RETRIES]"
            
            if [ "$COUNTRY" != "US" ] && [ "$COUNTRY" != "ERROR" ]; then
              echo "VPN ESTABLISHED: Exit IP is $IP ($COUNTRY)"
              exit 0
            fi
            COUNT=$((COUNT+1))
          done
          
          echo "ERROR: Failed to establish non-US VPN connection after $((MAX_RETRIES * 10))s."
          echo "--- VPN LOGS ---"
          cat vpn.log
          exit 1
          
      - name: Sync Global Metadata
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python spot_scraper.py --limit $TOP --metadata-only

      - name: Stop VPN
        if: always()
        run: sudo killall openvpn || true

  run-scrapers:
    needs: sync-metadata
    runs-on: ubuntu-latest
    timeout-minutes: 150
    strategy:
      fail-fast: false
      # Sequential by default, parallel if input is true
      max-parallel: ${{ github.event.inputs.parallel_execution == 'true' && 2 || 1 }}
      matrix:
        scraper_type: [spot, futures]
    
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COINALYZE_API_KEY: ${{ secrets.COINALYZE_API_KEY }}
      PYTHONUNBUFFERED: "1"
      
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup VPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn iproute2
          python get_vpn_config.py
          # Start OpenVPN in background
          sudo openvpn --config client.ovpn --log vpn.log --daemon
          
          echo "Waiting for VPN connection to establish..."
          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            sleep 10
            # Check exit IP
            IP_INFO=$(curl -s https://ipinfo.io/json || echo '{"country": "ERROR"}')
            COUNTRY=$(echo $IP_INFO | grep -oP '"country": "\K[^"]+')
            IP=$(echo $IP_INFO | grep -oP '"ip": "\K[^"]+')
            echo "Current IP: $IP ($COUNTRY) [Attempt $((COUNT+1))/$MAX_RETRIES]"
            
            if [ "$COUNTRY" != "US" ] && [ "$COUNTRY" != "ERROR" ]; then
              echo "VPN ESTABLISHED: Exit IP is $IP ($COUNTRY)"
              exit 0
            fi
            COUNT=$((COUNT+1))
          done
          
          echo "ERROR: Failed to establish non-US VPN connection after $((MAX_RETRIES * 10))s."
          echo "--- VPN LOGS ---"
          cat vpn.log
          exit 1
          
      - name: Run Spot Scraper
        if: matrix.scraper_type == 'spot'
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python spot_scraper.py --limit $TOP

      - name: Run Futures Scraper
        if: matrix.scraper_type == 'futures'
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python alts_scraper.py --limit $TOP --exchanges binance,bybit,okx

      - name: Stop VPN
        if: always()
        run: sudo killall openvpn || true
