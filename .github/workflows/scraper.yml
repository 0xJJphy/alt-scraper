name: Alts Scraper Pipeline

on:
  schedule:
    # Madrid is UTC+1 (Winter) / UTC+2 (Summer)
    # 1. Daily Close: 1 AM Madrid = 00:00 UTC (Winter) / 23:00 UTC (Summer)
    #    Target: ~00:15 UTC to ensure daily candle is closed and available.
    - cron: '15 0 * * *'

    # 2. Pre-Opening (US/Session): 3 PM Madrid = 14:00 UTC (Winter) / 13:00 UTC (Summer)
    #    Target: 14:00 UTC (compromise)
    - cron: '0 14 * * *'

    # 3. Pre-Close/Evening: 7 PM Madrid = 18:00 UTC (Winter) / 17:00 UTC (Summer)
    #    Target: 18:00 UTC
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      lookback_days:
        description: 'Days to look back (default: 1)'
        required: false
        default: '1'
      top_n:
        description: 'Number of top tokens (default: 50)'
        required: false
        default: '50'
      parallel_execution:
        description: 'Run Spot and Futures in parallel (default: false)'
        type: boolean
        required: false
        default: false

    env:
      PYTHONUNBUFFERED: "1"

jobs:
  sync-metadata:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COINALYZE_API_KEY: ${{ secrets.COINALYZE_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Cloudflare WARP
        run: |
          # Install Cloudflare WARP
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install -y cloudflare-warp

          # Register and connect
          echo "[WARP] Registering..."
          warp-cli --accept-tos registration new

          echo "[WARP] Setting mode to warp..."
          warp-cli --accept-tos mode warp

          echo "[WARP] Connecting..."
          warp-cli --accept-tos connect

          # Wait for connection
          echo "[WARP] Waiting for connection..."
          sleep 10

          # Verify connection
          for i in {1..6}; do
            STATUS=$(warp-cli status 2>/dev/null || echo "Disconnected")
            echo "[WARP] Status: $STATUS"

            if echo "$STATUS" | grep -q "Connected"; then
              IP_INFO=$(curl -s --connect-timeout 5 https://ipinfo.io/json || echo '{}')
              IP=$(echo "$IP_INFO" | grep -oP '"ip":\s*"\K[^"]+' || echo "unknown")
              COUNTRY=$(echo "$IP_INFO" | grep -oP '"country":\s*"\K[^"]+' || echo "unknown")
              ORG=$(echo "$IP_INFO" | grep -oP '"org":\s*"\K[^"]+' || echo "unknown")
              echo "[WARP] Connected! IP: $IP, Country: $COUNTRY, Org: $ORG"

              # WARP uses Cloudflare's network which routes through various countries
              # The key is that Binance sees Cloudflare IP, not Azure/GitHub IP
              if echo "$ORG" | grep -qi "cloudflare"; then
                echo "[WARP] SUCCESS: Traffic routed through Cloudflare"
                exit 0
              fi
            fi

            sleep 5
          done

          echo "[ERROR] Failed to establish WARP connection"
          warp-cli status
          exit 1

      - name: Sync Global Metadata
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python spot_scraper.py --limit $TOP --metadata-only

      - name: Disconnect WARP
        if: always()
        run: warp-cli disconnect 2>/dev/null || true

  run-scrapers:
    needs: sync-metadata
    runs-on: ubuntu-latest
    timeout-minutes: 150
    strategy:
      fail-fast: false
      # Sequential by default, parallel if input is true
      max-parallel: ${{ github.event.inputs.parallel_execution == 'true' && 2 || 1 }}
      matrix:
        scraper_type: [spot, futures]

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COINALYZE_API_KEY: ${{ secrets.COINALYZE_API_KEY }}
      PYTHONUNBUFFERED: "1"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Cloudflare WARP
        run: |
          # Install Cloudflare WARP
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install -y cloudflare-warp

          # Register and connect
          echo "[WARP] Registering..."
          warp-cli --accept-tos registration new

          echo "[WARP] Setting mode to warp..."
          warp-cli --accept-tos mode warp

          echo "[WARP] Connecting..."
          warp-cli --accept-tos connect

          # Wait for connection
          echo "[WARP] Waiting for connection..."
          sleep 10

          # Verify connection
          for i in {1..6}; do
            STATUS=$(warp-cli status 2>/dev/null || echo "Disconnected")
            echo "[WARP] Status: $STATUS"

            if echo "$STATUS" | grep -q "Connected"; then
              IP_INFO=$(curl -s --connect-timeout 5 https://ipinfo.io/json || echo '{}')
              IP=$(echo "$IP_INFO" | grep -oP '"ip":\s*"\K[^"]+' || echo "unknown")
              COUNTRY=$(echo "$IP_INFO" | grep -oP '"country":\s*"\K[^"]+' || echo "unknown")
              ORG=$(echo "$IP_INFO" | grep -oP '"org":\s*"\K[^"]+' || echo "unknown")
              echo "[WARP] Connected! IP: $IP, Country: $COUNTRY, Org: $ORG"

              # WARP uses Cloudflare's network which routes through various countries
              # The key is that Binance sees Cloudflare IP, not Azure/GitHub IP
              if echo "$ORG" | grep -qi "cloudflare"; then
                echo "[WARP] SUCCESS: Traffic routed through Cloudflare"
                exit 0
              fi
            fi

            sleep 5
          done

          echo "[ERROR] Failed to establish WARP connection"
          warp-cli status
          exit 1

      - name: Run Spot Scraper
        if: matrix.scraper_type == 'spot'
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python spot_scraper.py --limit $TOP

      - name: Run Futures Scraper
        if: matrix.scraper_type == 'futures'
        run: |
          TOP=${{ github.event.inputs.top_n || 50 }}
          python alts_scraper.py --limit $TOP --exchanges binance,bybit,okx

      - name: Disconnect WARP
        if: always()
        run: warp-cli disconnect 2>/dev/null || true
